{% extends 'base.html' %}

{% block styles %}
#patient_list_div, #patient_info_div {
  height: calc(100vh - 25vh);
  background-color: lightgrey;
  overflow-y:auto;
  overflow-x:hidden;
}

#PrescriptionModalBody {
  height: calc(100vh - 30vh);
  overflow-y:auto;
  overflow-x:hidden;
}

.small-close-btn {
  height: 0.25em;
  width: 0.25em;
  padding: 0.25em 0.25em;
  padding-y: 0.25rem;
  padding-x: 0.25rem;
  font-size: 1rem;
  border-radius: var(--bs-border-radius-sm);
}

.num {
  width: 40px;
  display: inline-block;
}
{% endblock styles %}

{% block content %}
<nav hidden>
  <ul class="pagination justify-content-center scrollable-div" id="legend">
    <strong></strong>
  </ul>
</nav>

<div class="modal fade" id="addPrescriptionModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl ui-front" role="document">
      <div class="modal-content" style='background-color:rgb(255,255,255,0); border:0px'>
          <div class="modal-body">
              <div class="card border-dark mb-3">
                  <div class="card-header">
                    Add Prescription(s) for <span id="prescriptionPatientName"></span>
                    <button type="button" class="btn-close float-end" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="card-body text-dark" id="PrescriptionModalBody"></div>
                  <div class="modal-footer justify-content-between">
                      <button type="button" class="btn btn-primary float-left" id="addBtn">Add</button>
                      <button type="button" class="btn btn-secondary float-right" data-dismiss="modal" onclick="$('#addPrescriptionModal').modal('hide');">Close</button>
                      <button type="button" class="btn btn-success float-right" onclick="processPrescription();">Create Prescription</button>
                  </div>
                </div>
          </div>
      </div>
  </div>
</div>

<datalist id="id_medicine_list">
  {% for medicine in medicines %}
  <option value="{{medicine.name}}">{{medicine.name}}</option>
  {% endfor %}
</datalist>

<ul class="nav nav-tabs" id="myTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="patient_list" data-bs-toggle="tab" data-bs-target="#patient_tab">Patient(s)</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="appointment_list" data-bs-toggle="tab" data-bs-target="#appointment_tab">Appointment(s)</button>
  </li>
</ul>
<div class="tab-content" id="myTabContent">
  <div class="tab-pane fade show active" id="patient_tab" role="tabpanel" aria-labelledby="patient_tab">
    <div class="row">
      <div class="col-2 border border-success p-2 mb-2 border-5" id="patient_list_div">
        <input type="text" onkeyup="filter_patient()" id="id_filter_patient" class="form-control my-2" placeholder="Filter Patient(s)">
        <div class="accordion" id="patients">
          <ul class="list-group">
            {% for patient in patients %}
            <li style="cursor: pointer;" class="card-body list-group-item list-group-item-action border border-dark patient" id="patient_{{patient.id}}"
              data-patient_id="{{patient.id}}" data-patient_name="{{patient.name}}" data-patient_age="{{patient.age}}" onclick="showPatientDetails(this);">
              {{patient.name}}
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      <div class="col-10 border border-primary p-2 mb-2 border-5" id="patient_info_div">
        <div id="patient_info" hidden>
          <ul class="list-group">
            <li class="list-group-item border border-dark">
              <div class="row">
                  <div class="col-5">
                    <strong>Patient Name: </strong><span id="patient_info_name"></span>
                  </div>
                  <div class="col-2">
                    <strong>Patient ID: </strong><span id="patient_info_id"></span>
                  </div>
                  <div class="col-4">
                    <strong>Patient Age: </strong><span id="patient_info_age"></span>
                  </div>
                  <div class="col-1">
                    <button type="button" class="btn btn-sm btn-primary float-end" onclick="$('#addPrescriptionModal').modal('show')">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
              </div>
            </li>
          </ul>
        </div>
        <br/>
        <div id="patient_prescription" hidden>
          <div class="row" id="prescription_cards">
            <div class="col-sm-4 mb-3 mb-sm-0">
              <div class="card text-bg-primary mb-3" style="max-width: 18rem;">
                <div class="card-header">Header</div>
                <div class="card-body">
                  <h5 class="card-title">Primary card title</h5>
                  <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                </div>
              </div>
            </div>
            <div class="col-sm-4 mb-3 mb-sm-0">
              <div class="card text-bg-primary mb-3" style="max-width: 18rem;">
                <div class="card-header">Header</div>
                <div class="card-body">
                  <h5 class="card-title">Primary card title</h5>
                  <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                </div>
              </div>
            </div>
            <div class="col-sm-4 mb-3 mb-sm-0">
              <div class="card text-bg-primary mb-3" style="max-width: 18rem;">
                <div class="card-header">Header</div>
                <div class="card-body">
                  <h5 class="card-title">Primary card title</h5>
                  <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                </div>
              </div>
            </div>
            <div class="col-sm-4 mb-3 mb-sm-0">
              <div class="card text-bg-primary mb-3" style="max-width: 18rem;">
                <div class="card-header">Header</div>
                <div class="card-body">
                  <h5 class="card-title">Primary card title</h5>
                  <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-pane fade" id="appointment_tab" role="tabpanel" aria-labelledby="appointment_tab">...</div>
</div>

  <script type="application/javascript">
    $(function(){
      document.getElementById('addBtn').addEventListener('click', event => {
        form = `<div class="input-group input-group-sm mb-3">
          <input type="text" name="medicine_name" class="form-control form-control-sm my-2" placeholder="Medicine Name" style="width: 130px;" list="id_medicine_list" autocomplete="off">
          <input type="number" name="before_breakfast" class="form-control form-control-sm my-2" placeholder="Before Breakfast" min="0" oninput="validity.valid||(value='');">
          <input type="number" name="after_breakfast" class="form-control form-control-sm my-2" placeholder="After Breakfast" min="0" oninput="validity.valid||(value='');">
          <input type="number" name="before_lunch" class="form-control form-control-sm my-2" placeholder="Before Lunch" min="0" oninput="validity.valid||(value='');">
          <input type="number" name="after_lunch" class="form-control form-control-sm my-2" placeholder="After Lunch" min="0" oninput="validity.valid||(value='');">
          <input type="number" name="before_dinner" class="form-control form-control-sm my-2" placeholder="Before Dinner" min="0" oninput="validity.valid||(value='');">
          <input type="number" name="after_dinner" class="form-control form-control-sm my-2" placeholder="After Dinner" min="0" oninput="validity.valid||(value='');">
          <span class="input-group-text">
            <button type="button" class="btn-close small-close-btn my-2" name="remove_medicine"></button>
          </span>
          <p class="invalid-feedback"><strong>This field required valid value</strong></p>
        </div>`
        document.getElementById('PrescriptionModalBody').insertAdjacentHTML('beforeend', form);
        identityRemoveBtn = document.querySelectorAll('button[name="remove_medicine"]');
        identityRemoveBtn.forEach(el => el.addEventListener('click', event => {
          event.target.parentNode.parentNode.remove();
        }));
      });
    });

    function filter_patient() {
      var filter, i;
      filter = document.getElementById("id_filter_patient").value.toUpperCase();
      let cells = document.querySelectorAll('.patient');
      for (i = 0; i < cells.length; i++) {
        let patient_name = cells[i].getAttribute('data-patient_name');
        let patient_id = cells[i].getAttribute('data-patient_id');
        if ((patient_name.toUpperCase().indexOf(filter) > -1) || (patient_id.toUpperCase().indexOf(filter) > -1)) {
          cells[i].style.display = "";
        } else {
          cells[i].style.display = "none";
        }
      }
    }

    function showPatientDetails(ele) {
      let patient_name = ele.getAttribute('data-patient_name');
      let patient_id = ele.getAttribute('data-patient_id');
      let patient_age = ele.getAttribute('data-patient_age');
      document.getElementById('patient_info').removeAttribute('hidden');
      document.getElementById('patient_prescription').removeAttribute('hidden');
      document.getElementById('patient_info_name').innerText = patient_name;
      document.getElementById('prescriptionPatientName').innerText = patient_name;
      document.getElementById('patient_info_id').innerText = patient_id;
      document.getElementById('patient_info_age').innerText = patient_age;
      document.querySelectorAll('.patient').forEach(x => {
        x.classList.remove("active");
      });
      ele.classList.add("active");
      fetchPatientDetails(patient_id);
    }

    function populatePrescriptions(prescriptions) {
      let prescription_cardsEle = document.getElementById('prescription_cards');
      let row = '';
      prescription_cardsEle.innerHTML = row;
      prescriptions.forEach(prescription => {
        row = row + `<div class="col-sm-4 mb-3 mb-sm-0">
          <div class="card text-bg-primary mb-3" style="max-width: 18rem;">
            <div class="card-header">`+prescription.name+`</div>
            <div class="card-body text-center">
              <button class="btn btn-sm btn-success float-center" id="prescription_`+prescription.id+`">View</button>
              <h5 class="card-title" hidden>Primary card title</h5>
              <p class="card-text" hidden>Some quick example text to build on the card title and make up the bulk of the card's content.</p>
            </div>
          </div>
        </div>`;
      });
      prescription_cardsEle.innerHTML = row;
    }

    function createPrescription() {
      let medicine_name = document.querySelectorAll('[name="medicine_name"]');
      let before_breakfast = document.querySelectorAll('[name="before_breakfast"]');
      let after_breakfast = document.querySelectorAll('[name="after_breakfast"]');
      let before_lunch = document.querySelectorAll('[name="before_lunch"]');
      let after_lunch = document.querySelectorAll('[name="after_lunch"]');
      let before_dinner = document.querySelectorAll('[name="before_dinner"]');
      let after_dinner = document.querySelectorAll('[name="after_dinner"]');

      let prescription_list = [];
      for (let index = 0; index < medicine_name.length; index++) {
        if (medicine_name[index].value != '') {
          var obj = new Object();
          obj.medicine_name = medicine_name[index].value;
          obj.before_breakfast = Number(before_breakfast[index].value);
          obj.after_breakfast = Number(after_breakfast[index].value);
          obj.before_lunch = Number(before_lunch[index].value);
          obj.after_lunch = Number(after_lunch[index].value);
          obj.before_dinner = Number(before_dinner[index].value);
          obj.after_dinner = Number(after_dinner[index].value);
          prescription_list.push(obj);
        }
      }
      if (prescription_list != []) {
        return JSON.stringify(prescription_list);
      } else {
        alert('Please fill in all fields.');
      }
    }

    function fetchPatientDetails(patient_id) {
      $.ajax({
        url : "{% url 'dataStorage:adminpg' %}",
        type : "POST",
        data : {
          'patient_id': patient_id,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        beforeSend: function (xhr) {
          xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
        },
        success : function(HttpResponse, textMsg, xhr) {
          notify_message(HttpResponse.message, 'info');
          window.scrollTo(0, 0);
          populatePrescriptions(HttpResponse.prescriptions);
        },
        error : function(xhr, errmsg, err) {
          console.log(xhr);
          window.scrollTo(0, 0);
          alert('Please fill in all fields.');
        },
        statusCode: {
          401: function() {
            window.scrollTo(0, 0);
            location.reload();
          }
        }
      });
    }

    function processPrescription() {
      let patient_id = document.getElementById('patient_info_id').innerText;
      $.ajax({
        url : "{% url 'dataStorage:adminpg' %}",
        type : "PUT",
        data : {
          'patient_id': patient_id,
          'prescription': createPrescription(),
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        beforeSend: function (xhr) {
          xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
        },
        success : function(HttpResponse, textMsg, xhr) {
          notify_message(HttpResponse.message, 'info');
          window.scrollTo(0, 0);
          document.getElementById("PrescriptionModalBody").innerHTML = "";
          $('#addPrescriptionModal').modal('hide');
          document.getElementById("patient_"+patient_id).click();
        },
        error : function(xhr, errmsg, err) {
          console.log(xhr);
          window.scrollTo(0, 0);
          alert('Please fill in all fields.');
        },
        statusCode: {
          401: function() {
            window.scrollTo(0, 0);
            location.reload();
          }
        }
      });
    }
  </script>
{% endblock content %}
